#!/bin/sh
exit 1;
# ------------------------------------------------------------
#
# CVE-2018-3646 --> Enable ESXi Side-Channel-Aware Scheduler setting using ESXCLI
#

# ESXi 6.7-U2 and later releases of ESXI offer both SCAv1 and SCAv2 protection schedulers
# Versions of ESXi before 6.7-U2 can only use the SCAv1 protection scheduler
if [ 1 -eq 1 ]; then
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigation ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then
esxcli system settings kernel set -s hyperthreadingMitigation -v TRUE; # Setting kernel parameter "hyperthreadingMitigation" to TRUE acts to 'Restrict the simultaneous use of logical processors from the same hyperthreaded core as necessary to mitigate a security vulnerability.' -quoted from esxcli description on 20200308-063818
fi;
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigationIntraVM ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v FALSE; # Use SCAv2 Scheduler (ESXi 6.7-U2 and later, only)
if [ 0 -eq 1 ]; then
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v TRUE; # Use SCAv1 in lieu of SCAv2 by setting kernel parameter "hyperthreadingMitigationIntraVM" to TRUE
fi;
fi;
fi;


# ------------------------------------------------------------
#
# Citation(s)
#
#   kb.vmware.com  |  "VMware response to ‘L1 Terminal Fault - VMM’ (L1TF - VMM) Speculative-Execution vulnerability in Intel processors for vSphere: CVE-2018-3646 (55806)"  |  https://kb.vmware.com/s/article/55806
#
# ------------------------------------------------------------