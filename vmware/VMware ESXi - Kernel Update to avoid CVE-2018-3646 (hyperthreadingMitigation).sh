#!/bin/sh
# ------------------------------------------------------------
#
# CVE-2018-3646 --> Enable ESXi Side-Channel-Aware Scheduler setting using ESXCLI
#

if [ 1 -eq 1 ]; then; 
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigation ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then 
echo "Setting kernel parameter 'hyperthreadingMitigation' to TRUE, which acts to 'Restrict the simultaneous use of logical processors from the same hyperthreaded core as necessary to mitigate a security vulnerability.' -quoted from esxcli description on 20200308-063818"; 
esxcli system settings kernel set -s hyperthreadingMitigation -v TRUE; 
fi; 
if [ $(vmware -l | sed -rne 's/^([a-zA-Z\_\-\(\)\=\ ]+) ([0-9\.]+) (Update.+)$/\2/p' | grep '^6.7' | wc -l) -eq 0 ]; then 
echo "Versions of ESXi before 6.7-U2 can only use the SCAv1 protection scheduler (used by-default, cannot disable)"; 
else 
echo "ESXi 6.7-U2 and later releases of ESXI offer both SCAv1 and SCAv2 protection schedulers"; 
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigationIntraVM ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then 
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v FALSE; 
echo "Setting kernel parameter 'hyperthreadingMitigationIntraVM' to FALSE to 'Use the SCAv2 Security Scheduler' (available starting with ESXi 6.7 U2)"; 
if [ 0 -eq 1 ]; then 
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v TRUE; 
echo "Setting kernel parameter 'hyperthreadingMitigationIntraVM' to FALSE to 'Use the SCAv1 Security Scheduler' (deprecated, used by ESXi before 6.7-U2)"; 
fi; 
fi; 
fi; 
fi; 


# ------------------------------------------------------------
#
# Citation(s)
#
#   kb.vmware.com  |  "VMware response to ‘L1 Terminal Fault - VMM’ (L1TF - VMM) Speculative-Execution vulnerability in Intel processors for vSphere: CVE-2018-3646 (55806)"  |  https://kb.vmware.com/s/article/55806
#
# ------------------------------------------------------------